<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Civic Issue</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Add EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script>
    emailjs.init("dpVgK5PVSKB1uV2cW"); // Your Public Key
  </script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

  <!-- Navbar -->
  <nav class="bg-blue-700 text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <a href="index.html" class="text-2xl font-bold tracking-wide">CivicSense</a>
      <div class="space-x-6">
        <a href="index.html" class="hover:text-gray-200">Home</a>
        <a href="report.html" class="hover:text-gray-200 font-semibold">Report</a>
        <a href="about.html" class="hover:text-gray-200">About</a>
      </div>
    </div>
  </nav>

  <!-- Main Section -->
  <main class="flex-grow py-16 relative" 
        style="background: url('https://images.unsplash.com/photo-1582213782179-e0d53f98f2ca?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80') no-repeat center center/cover;">
    <!-- Overlay -->
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm"></div>

    <div class="relative max-w-4xl mx-auto px-6 z-10">
      <h2 class="text-3xl font-bold text-white mb-8 text-center drop-shadow-lg">Report an Issue</h2>

      <div class="bg-white/80 p-6 rounded-xl shadow-lg border border-gray-200/30">

        <!-- Step 1: Problem Type -->
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">Select Problem Type</label>
          <select id="problemType" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-400">
            <option value="">-- Select --</option>
            <option value="pothole">Pothole</option>
            <option value="streetlight">Streetlight</option>
            <option value="garbage">Garbage</option>
            <option value="waterlogging">Waterlogging</option>
          </select>
        </div>

        <!-- Step 2: Camera -->
        <div id="cameraSection" class="hidden text-center mb-4">
          <!-- Start Camera Button for Mobile -->
          <button id="startCameraBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg mb-2">Start Camera</button>
          <video id="camera" autoplay playsinline class="mx-auto rounded-lg shadow-md mb-2 w-full max-w-md h-auto"></video>
          <canvas id="canvas" class="hidden mx-auto rounded-lg shadow-md mb-2 w-full max-w-md h-auto"></canvas>
          <div class="flex justify-center gap-2 mb-2">
            <button id="switchCameraBtn" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Switch Camera</button>
            <button id="captureBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-lg" disabled>
              <i class="fas fa-camera mr-2"></i>Capture
            </button>
          </div>
        </div>

        <!-- Step 3: Location -->
        <div id="locationSection" class="hidden mb-4">
          <p id="locationText" class="text-black font-medium"></p>
        </div>

        <!-- Step 4: Comment + Audio -->
        <div id="commentAudioSection" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- Comment -->
          <div>
            <label for="comment" class="block text-gray-700 font-semibold mb-2">Describe Your Problem</label>
            <textarea id="comment" rows="5" class="w-full border rounded p-2" placeholder="Enter details about your issue..."></textarea>
          </div>
          <!-- Audio -->
          <div>
            <label class="block text-gray-700 font-semibold mb-2">Attach Audio (Optional)</label>
            <div class="flex flex-col space-y-2">
              <button id="recordBtn" class="bg-red-600 text-white px-4 py-2 rounded w-full">Start Recording</button>
              <button id="stopBtn" class="hidden bg-gray-600 text-white px-4 py-2 rounded w-full">Stop Recording</button>
              <audio id="audioPlayback" controls class="hidden w-full"></audio>
            </div>
          </div>
        </div>

        <!-- Step 5: Submit -->
        <div id="submitSection" class="hidden mb-4">
          <button id="submitBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200">
            Submit Report
          </button>
        </div>

        <!-- Confirmation Card -->
        <div id="confirmationCard" class="hidden mt-4 bg-green-50 border border-green-400 text-green-700 px-4 py-3 rounded shadow-sm text-center"></div>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-blue-700 text-white py-6 mt-0 border-t-0">
    <div class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center">
      <p class="text-sm">© 2025 CivicSense. All rights reserved.</p>
      <div class="space-x-4 mt-3 md:mt-0">
        <a href="#" class="hover:text-gray-300"><i class="fab fa-facebook"></i></a>
        <a href="#" class="hover:text-gray-300"><i class="fab fa-twitter"></i></a>
        <a href="#" class="hover:text-gray-300"><i class="fab fa-instagram"></i></a>
      </div>
    </div>
  </footer>

  <script>
    const problemTypeSelect = document.getElementById('problemType');
    const cameraSection = document.getElementById('cameraSection');
    const commentAudioSection = document.getElementById('commentAudioSection');
    const submitSection = document.getElementById('submitSection');
    const confirmationCard = document.getElementById('confirmationCard');
    const locationSection = document.getElementById('locationSection');
    const locationText = document.getElementById('locationText');

    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const switchBtn = document.getElementById('switchCameraBtn');
    const startCameraBtn = document.getElementById('startCameraBtn');

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const audioPlayback = document.getElementById("audioPlayback");
    const submitBtn = document.getElementById("submitBtn");

    let stream = null;
    let photoTaken = false;
    let useFrontCamera = false;
    let mediaRecorder, audioChunks = [];
    let reportSubmitted = false;
    let currentCoords = null;

    // When Problem Type Selected
    problemTypeSelect.addEventListener('change', () => {
      if (reportSubmitted) {
        confirmationCard.textContent = "⚠️ You have already submitted a report. Please wait before submitting again.";
        confirmationCard.classList.remove("hidden");
        return;
      }
      resetForm();
      if (problemTypeSelect.value) {
        cameraSection.classList.remove('hidden');
      }
    });

    // Start Camera (Mobile-friendly)
    startCameraBtn.addEventListener('click', async () => {
      startCameraBtn.disabled = true;
      await startCamera();
      captureBtn.disabled = false;
    });

    async function startCamera() {
      if (stream) stream.getTracks().forEach(track => track.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: useFrontCamera ? 'user' : 'environment' }, audio: false });
        video.srcObject = stream;
      } catch (err) {
        console.error("Camera Error:", err);
        alert("Camera access required!");
        startCameraBtn.disabled = false;
      }
    }

    // Switch Camera
    switchBtn.addEventListener('click', () => {
      useFrontCamera = !useFrontCamera;
      startCamera();
    });

    // Capture Photo
    captureBtn.addEventListener('click', () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      canvas.classList.remove('hidden');
      video.classList.add('hidden');

      if (stream) stream.getTracks().forEach(track => track.stop());
      photoTaken = true;

      // Show location, comment/audio, and submit
      locationSection.classList.remove('hidden');
      commentAudioSection.classList.remove('hidden');
      submitSection.classList.remove('hidden');

      // Fetch location
      if (navigator.geolocation) {
        locationText.textContent = "Fetching location...";
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          currentCoords = { lat, lng };
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
            const data = await res.json();
            locationText.textContent = `${data.display_name} (Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)})`;
          } catch {
            locationText.textContent = `Lat: ${lat}, Lng: ${lng}`;
          }
        }, () => {
          locationText.textContent = "Unable to detect location.";
        });
      } else {
        locationText.textContent = "Geolocation not supported.";
      }
    });

    // Audio Recording
    recordBtn.addEventListener("click", async () => {
      const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(audioStream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks);
        audioPlayback.src = URL.createObjectURL(audioBlob);
        audioPlayback.classList.remove("hidden");
      };
      mediaRecorder.start();
      recordBtn.classList.add("hidden");
      stopBtn.classList.remove("hidden");
    });

    stopBtn.addEventListener("click", () => {
      mediaRecorder.stop();
      recordBtn.classList.remove("hidden");
      stopBtn.classList.add("hidden");
    });

    // Submit Report
    submitBtn.addEventListener('click', () => {
      if (!photoTaken) {
        confirmationCard.textContent = "⚠️ Please capture an image before submitting.";
        confirmationCard.classList.remove('hidden');
        return;
      }

      const comment = document.getElementById("comment").value.trim();
      if (!comment) {
        confirmationCard.textContent = "⚠️ Please describe your problem before submitting.";
        confirmationCard.classList.remove("hidden");
        return;
      }

      const reportData = {
        type: problemTypeSelect.value,
        comment: comment,
        location: locationText.textContent || "Not Available",
        time: new Date().toLocaleString()
      };

      let reports = JSON.parse(localStorage.getItem('reports')) || [];
      reports.push(reportData);
      localStorage.setItem('reports', JSON.stringify(reports));

      // Send Email
      emailjs.send("service_a4y82kl", "template_ujq8rfd", reportData, "dpVgK5PVSKB1uV2cW")
        .then((response) => console.log("Email sent!", response))
        .catch((error) => console.error("Email failed", error));

      // Upload Image
      canvas.toBlob((blob) => {
        const formData = new FormData();
        formData.append('file', blob);
        formData.append('upload_preset', 'report-upload'); // Replace with your preset

        fetch('https://api.cloudinary.com/v1_1/dvgh1kmws/image/upload', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => console.log('Image uploaded:', data.secure_url))
        .catch(err => console.error('Upload failed:', err));
      }, 'image/jpeg');

      // Hide sections
      cameraSection.classList.add('hidden');
      commentAudioSection.classList.add('hidden');
      submitSection.classList.add('hidden');
      locationSection.classList.add('hidden');
      video.classList.add('hidden');
      canvas.classList.add('hidden');
      reportSubmitted = true;

      confirmationCard.textContent = "✅ Report submitted! Your photo and details are under system verification. You will be notified once the review is complete.";
      confirmationCard.classList.remove('hidden');
    });

    // Reset Form
    function resetForm() {
      photoTaken = false;
      if (stream) stream.getTracks().forEach(track => track.stop());
      cameraSection.classList.add('hidden');
      commentAudioSection.classList.add('hidden');
      submitSection.classList.add('hidden');
      locationSection.classList.add('hidden');
      confirmationCard.classList.add('hidden');
      audioPlayback.classList.add('hidden');
      document.getElementById("comment").value = "";
      canvas.classList.add('hidden');
      video.classList.remove('hidden');
      startCameraBtn.disabled = false;
    }
  </script>

</body>
</html>
